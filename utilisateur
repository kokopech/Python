from datetime import datetime


class Utilisateur:
    compteur_id = 1

    def __init__(self, nom_complet, email, type_utilisateur):
        self.__id = Utilisateur.compteur_id#Attribut privé
        Utilisateur.compteur_id += 1#auto-incrementation
        self.__nom_complet = nom_complet#Attribut privé
        self.__email = email#Attribut privé
        self.__type_utilisateur = type_utilisateur#Attribut privé


    #Les getters
    @property
    def id(self):
        return self.__id

    @property
    def nom_complet(self):
        return self.__nom_complet

    @property
    def email(self):
        return self.__email

    @property
    def type_utilisateur(self):
        return self.__type_utilisateur


    #Les setters
    @nom_complet.setter
    def nom_complet(self, nouveau_nom):
        if len(nouveau_nom) >= 3:
            self.__nom_complet = nouveau_nom
        else:
            print("Le nom doit contenir au moins 3 caractères")

    @email.setter
    def email(self, nouvel_email):
        if "@" in nouvel_email and "." in nouvel_email:
            self.__email = nouvel_email
        else:
            print("Email invalide")

    def __str__(self):
        return f"ID: {self.__id}, Nom: {self.__nom_complet}, Email: {self.__email}, Type: {self.__type_utilisateur}"

    def _a_les_droits_bibliothecaire(self):
        return self.__type_utilisateur == "Bibliothécaire"# donner l'autorisation au bibliothécaire de modifier la bibliotheque


class Lecteur(Utilisateur):

    def __init__(self, nom_complet, email):
        super().__init__(nom_complet, email, "Lecteur")
        self.__livres_empruntes = {}#créer un dictionnaire pour stocker les id des livres emprunté et la date d'emprunt

    #Getter
    @property
    def livres_empruntes(self):
        return self.__livres_empruntes.copy()

    def emprunter_livre(self, livre):
        if livre.est_disponible():#regarder si il y a des exemplaire du livre
            livre.nbr_exemplaire_disp = livre.nbr_exemplaire_disp - 1 # enlever un exemplaire pour le livre mis en argumment
            self.__livres_empruntes[livre.ID] = datetime.now() #donner la date de l'emprunt
            print(f"{self.nom_complet} a emprunté '{livre.titre}'")
            return True
        else:
            print(f"Le livre '{livre.titre}' n'est pas disponible")
            return False

    def rendre_livre(self, livre):
        if livre.ID in self.__livres_empruntes:
            livre.nbr_exemplaire_disp = livre.nbr_exemplaire_disp + 1 # ajouter un exemplaire pour le livre mis en argumment
            date_emprunt = self.__livres_empruntes[livre.ID]
            jours_emprunt = (datetime.now()-date_emprunt)# calcule pour avoir le temps de l'emprunt


            del self.__livres_empruntes[livre.ID]#supprimer l'emprunt de la liste
            print(f"{self.nom_complet} a rendu '{livre.titre}' après {jours_emprunt} jours")
            return True
        else:
            print(f"{self.nom_complet} n'a pas emprunté ce livre")
            return False

    def afficher_emprunts(self):
        if not self.__livres_empruntes:#verifier s'il y a des emprunts dans le dictionnaire
            print(f"{self.nom_complet} n'a aucun livre emprunté")
        else:
            for livre_id, date_emprunt in self.__livres_empruntes.items():#faire une boucle pour rcuperer chaque id des livres et les date d'emprunt dans le dictionnaire
                print(f"Livre ID {livre_id} emprunté le {date_emprunt}")


class Bibliothecaire(Utilisateur):

    def __init__(self, nom_complet, email):
        super().__init__(nom_complet, email, "Bibliothécaire")

    def ajouter_livre(self, bibliotheque, livre):
        if not self._a_les_droits_bibliothecaire():#regarder si il n'a pas les droits d'un bibliothecaire
            print("Action refusée : droits insuffisants")
            return False

        bibliotheque._ajouter_livre_interne(livre)#fonction qui permet d'ajouter le livre dans la bibliotheque
        print(f"{self.nom_complet} (bibliothécaire) a ajouté le livre '{livre.titre}'")
        return True

    def modifier_livre(self, livre, nouveau_titre=None, nouvel_auteur=None,
                       nouvelle_categorie=None, nouveau_nbr=None):
        if not self._a_les_droits_bibliothecaire():
            print("Action refusée : droits insuffisants")
            return False
        if nouveau_titre:#regarde si le l'information a mofidier est un titre un auteur une categorie ou un nombre d'exemplaire
            livre.titre = nouveau_titre
        if nouvel_auteur:
            livre.auteur = nouvel_auteur
        if nouvelle_categorie:
            livre.categorie = nouvelle_categorie
        if nouveau_nbr is not None:
            livre.nbr_exemplaire_disp = nouveau_nbr

        print(f"{self.nom_complet} (bibliothécaire) a modifié le livre '{livre.titre}'")
        return True

    def supprimer_livre(self, bibliotheque, id_livre):
        if not self._a_les_droits_bibliothecaire():
            print("Action refusée : droits insuffisants")
            return False

        bibliotheque._supprimer_livre_interne(id_livre)#fonction qui permet de supprimmer le livre dans la bibliotheque
        print(f"{self.nom_complet} (bibliothécaire) a supprimé le livre ID {id_livre}")
        return True
